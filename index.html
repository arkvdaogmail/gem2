<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>V-DAO Notary (Final Version)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 20px; background: #111; color: #eee; }
        .container { max-width: 600px; margin: 40px auto; background: #222; padding: 30px; border-radius: 10px; }
        h1 { color: #58a6ff; }
        button { width: 100%; padding: 15px; font-size: 18px; color: white; background: #238636; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; }
        #result { margin-top: 20px; padding: 15px; background: #333; border-radius: 8px; font-family: monospace; word-break: break-all; min-height: 50px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>V-DAO Notary</h1>
        <p>This is the final, working version.</p>
        <hr style="border-color: #444; margin: 20px 0;">
        
        <input type="file" id="fileInput">
        <button id="notarizeBtn">Connect Wallet & Notarize</button>
        <div id="result"></div>
    </div>

    <script>
        document.getElementById('notarizeBtn').addEventListener('click', async () => {
            const resultDiv = document.getElementById('result');
            const file = document.getElementById('fileInput').files[0];

            // 1. Check for a file
            if (!file) {
                resultDiv.innerText = 'Error: Please select a file first.';
                return;
            }

            // 2. Check for the wallet (the simplest way)
            if (typeof window.connex === 'undefined') {
                resultDiv.innerText = 'Error: VeChain wallet not found. Please make sure the VeWorld extension is installed and unlocked.';
                return;
            }

            resultDiv.innerText = 'Working... Please check your wallet to approve.';
            
            try {
                // 3. Create the hash
                const fileBuffer = await file.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-256', fileBuffer);
                const hash = '0x' + Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

                // 4. Ask the wallet to sign the transaction
                const { txid } = await window.connex.vendor.sign('tx', [{
                    to: null,
                    value: '0x0',
                    data: hash,
                    comment: 'V-DAO Document Notarization'
                }]).request();

                // 5. Success
                const explorerUrl = `https://explore-testnet.vechain.org/transactions/${txid}`;
                resultDiv.innerHTML = `âœ… Success! TXID: <a href="${explorerUrl}" target="_blank" style="color: #58a6ff;">${txid}</a>`;

            } catch (error) {
                // This will catch if the user clicks "Reject" in their wallet
                resultDiv.innerText = `Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>
